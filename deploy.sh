#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

set -e

echo "üöÄ –ù–∞—á–∞–ª–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è Oktour..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [ "$EUID" -ne 0 ]; then 
    echo -e "${RED}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ root (sudo)${NC}"
    exit 1
fi

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
PROJECT_DIR="/var/www/oktour"
DOMAIN="oktour.travel"

echo -e "${YELLOW}üì¶ –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
apt update && apt upgrade -y

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
if ! command -v docker &> /dev/null; then
    echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker..."
    curl -fsSL https://get.docker.com -o get-docker.sh
    sh get-docker.sh
    rm get-docker.sh
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Compose
if ! command -v docker-compose &> /dev/null; then
    apt install docker-compose -y
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nginx
if ! command -v nginx &> /dev/null; then
    apt install nginx -y
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Certbot
if ! command -v certbot &> /dev/null; then
    apt install certbot python3-certbot-nginx -y
fi

echo -e "${GREEN}‚úì –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã${NC}"

echo -e "${YELLOW}üìÅ –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞...${NC}"
mkdir -p $PROJECT_DIR
cd $PROJECT_DIR

echo -e "${GREEN}‚úì –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞${NC}"

echo -e "${YELLOW}üîß –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker...${NC}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è docker-compose.prod.yml
if [ ! -f "docker-compose.prod.yml" ]; then
    echo -e "${RED}–û—à–∏–±–∫–∞: —Ñ–∞–π–ª docker-compose.prod.yml –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
    echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –≤ $PROJECT_DIR"
    exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
if [ ! -f ".env" ]; then
    echo "–°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞..."
    cat > .env << EOF
NODE_ENV=production
TELEGRAM_BOT_TOKEN=8304880903:AAHxEr9U4Ca6E0E-IGxyVMzDL56qocRihWg
TELEGRAM_CHAT_ID=-1003143468391
EOF
    echo -e "${YELLOW}‚ö†Ô∏è  –ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å TELEGRAM_BOT_TOKEN –∏ TELEGRAM_CHAT_ID –≤ .env${NC}"
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
mkdir -p data public/uploads/photo public/uploads/video public/kp

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (–≤–∞–∂–Ω–æ –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö!)
chmod -R 777 data
chmod -R 755 public/uploads public/kp
chown -R $USER:$USER public/uploads public/kp 2>/dev/null || true

# –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
echo "–°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
docker-compose -f docker-compose.prod.yml build

echo -e "${GREEN}‚úì Docker –Ω–∞—Å—Ç—Ä–æ–µ–Ω${NC}"

echo -e "${YELLOW}üåê –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx...${NC}"

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx
if [ -f "nginx.conf" ]; then
    cp nginx.conf /etc/nginx/sites-available/$DOMAIN
    ln -sf /etc/nginx/sites-available/$DOMAIN /etc/nginx/sites-enabled/
    
    # –£–¥–∞–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    rm -f /etc/nginx/sites-enabled/default
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    nginx -t
    
    # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx
    systemctl reload nginx
    
    echo -e "${GREEN}‚úì Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  –§–∞–π–ª nginx.conf –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É Nginx${NC}"
fi

echo -e "${YELLOW}üîí –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSL...${NC}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ DNS –∑–∞–ø–∏—Å–∏ –¥–ª—è $DOMAIN..."
IP=$(dig +short $DOMAIN | tail -n1)
SERVER_IP=$(curl -s ifconfig.me)

if [ "$IP" != "185.179.191.27" ] && [ "$IP" != "$SERVER_IP" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: DNS –∑–∞–ø–∏—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ${NC}"
    echo "   –û–∂–∏–¥–∞–µ–º—ã–π IP: 185.179.191.27"
    echo "   –¢–µ–∫—É—â–∏–π IP –¥–æ–º–µ–Ω–∞: $IP"
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# –ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
if [ ! -d "/etc/letsencrypt/live/$DOMAIN" ]; then
    echo "–ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
    certbot --nginx -d $DOMAIN -d www.$DOMAIN --non-interactive --agree-tos --email admin@$DOMAIN || {
        echo -e "${RED}–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞${NC}"
        echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:"
        echo "1. –î–æ–º–µ–Ω —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ IP —Å–µ—Ä–≤–µ—Ä–∞ (185.179.191.27)"
        echo "2. –ü–æ—Ä—Ç—ã 80 –∏ 443 –æ—Ç–∫—Ä—ã—Ç—ã –≤ —Ñ–∞–π—Ä–≤–æ–ª–µ"
        exit 1
    }
else
    echo "SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    certbot renew --dry-run
fi

echo -e "${GREEN}‚úì SSL –Ω–∞—Å—Ç—Ä–æ–µ–Ω${NC}"

echo -e "${YELLOW}üöÄ –®–∞–≥ 6: –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...${NC}"

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker-compose -f docker-compose.prod.yml up -d

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
sleep 5

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
if docker-compose -f docker-compose.prod.yml ps | grep -q "Up"; then
    echo -e "${GREEN}‚úì –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ${NC}"
else
    echo -e "${RED}‚úó –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è${NC}"
    docker-compose -f docker-compose.prod.yml logs
    exit 1
fi

echo -e "${YELLOW}üî• –®–∞–≥ 7: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞...${NC}"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ UFW
if ! command -v ufw &> /dev/null; then
    apt install ufw -y
fi

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤–∏–ª
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp

# –í–∫–ª—é—á–µ–Ω–∏–µ —Ñ–∞–π—Ä–≤–æ–ª–∞ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –≤–∫–ª—é—á–µ–Ω)
if ! ufw status | grep -q "Status: active"; then
    echo "y" | ufw enable
fi

echo -e "${GREEN}‚úì –§–∞–π—Ä–≤–æ–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω${NC}"

echo -e "${GREEN}‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!${NC}"
echo ""
echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: https://$DOMAIN"
echo ""
echo "üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: docker-compose -f docker-compose.prod.yml logs -f"
echo "   –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫: docker-compose -f docker-compose.prod.yml restart"
echo "   –û—Å—Ç–∞–Ω–æ–≤–∫–∞: docker-compose -f docker-compose.prod.yml down"
echo "   –°—Ç–∞—Ç—É—Å: docker-compose -f docker-compose.prod.yml ps"
echo ""


